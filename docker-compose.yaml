version: '3.9'

x-kong-config: &kong-env
  image: kong/kong-gateway:3.12
  restart: always
  environment:
    KONG_ROLE: data_plane
    KONG_DATABASE: "off"
    KONG_VITALS: "off"
    KONG_NGINX_WORKER_PROCESSES: "1"
    # Port configuration (default, overridden per service)
    KONG_PROXY_LISTEN: 0.0.0.0:8000
    KONG_SSL_PXY_LISTEN: 0.0.0.0:8443
    # Konnect Configuration
    KONG_CLUSTER_MTLS: pki
    KONG_CLUSTER_CONTROL_PLANE: pop-upl.konghq.com:443
    KONG_CLUSTER_SERVER_NAME: kong-cluster.konghq.com
    KONG_CLUSTER_TELEMETRY_ENDPOINT: pop-upl.konghq.com:443
    KONG_CLUSTER_TELEMETRY_SERVER_NAME: kong-cluster.konghq.com
    # Certificates (See SETUP_GUIDE.md or scripts/setup_certs.sh)
    KONG_CLUSTER_CERT: /etc/kong/tls/cluster.crt
    KONG_CLUSTER_CERT_KEY: /etc/kong/tls/cluster.key

services:
  # ===========================================================================
  # DEV ENV (Ports 8000, 8001)
  # ===========================================================================
  gateway-dev-external:
    <<: *kong-env
    container_name: kong-dev-external
    environment:
      <<: *kong-env
      KONG_KONNECT_TAGS: "external"
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_SSL_PXY_LISTEN: 0.0.0.0:8443
    ports: ["8000:8000", "8443:8443"]
    volumes:
      - ./certs/dev/cluster.crt:/etc/kong/tls/cluster.crt
      - ./certs/dev/cluster.key:/etc/kong/tls/cluster.key

  gateway-dev-internal:
    <<: *kong-env
    container_name: kong-dev-internal
    environment:
      <<: *kong-env
      KONG_KONNECT_TAGS: "internal"
      KONG_PROXY_LISTEN: 0.0.0.0:8001
      KONG_SSL_PXY_LISTEN: 0.0.0.0:8444
    ports: ["8001:8001", "8444:8444"]
    volumes:
      - ./certs/dev/cluster.crt:/etc/kong/tls/cluster.crt
      - ./certs/dev/cluster.key:/etc/kong/tls/cluster.key

  # ===========================================================================
  # UAT ENV (Ports 8002, 8003)
  # ===========================================================================
  gateway-uat-external:
    <<: *kong-env
    container_name: kong-uat-external
    environment:
      <<: *kong-env
      KONG_KONNECT_TAGS: "external"
      KONG_PROXY_LISTEN: 0.0.0.0:8002
      KONG_SSL_PXY_LISTEN: 0.0.0.0:8445
    ports: ["8002:8002", "8445:8445"]
    volumes:
      - ./certs/uat/cluster.crt:/etc/kong/tls/cluster.crt
      - ./certs/uat/cluster.key:/etc/kong/tls/cluster.key

  gateway-uat-internal:
    <<: *kong-env
    container_name: kong-uat-internal
    environment:
      <<: *kong-env
      KONG_KONNECT_TAGS: "internal"
      KONG_PROXY_LISTEN: 0.0.0.0:8003
      KONG_SSL_PXY_LISTEN: 0.0.0.0:8446
    ports: ["8003:8003", "8446:8446"]
    volumes:
      - ./certs/uat/cluster.crt:/etc/kong/tls/cluster.crt
      - ./certs/uat/cluster.key:/etc/kong/tls/cluster.key

  # ===========================================================================
  # STAGING ENV (Ports 8004, 8005)
  # ===========================================================================
  gateway-stg-external:
    <<: *kong-env
    container_name: kong-stg-external
    environment:
      <<: *kong-env
      KONG_KONNECT_TAGS: "external"
      KONG_PROXY_LISTEN: 0.0.0.0:8004
      KONG_SSL_PXY_LISTEN: 0.0.0.0:8447
    ports: ["8004:8004", "8447:8447"]
    volumes:
      - ./certs/stg/cluster.crt:/etc/kong/tls/cluster.crt
      - ./certs/stg/cluster.key:/etc/kong/tls/cluster.key

  gateway-stg-internal:
    <<: *kong-env
    container_name: kong-stg-internal
    environment:
      <<: *kong-env
      KONG_KONNECT_TAGS: "internal"
      KONG_PROXY_LISTEN: 0.0.0.0:8005
      KONG_SSL_PXY_LISTEN: 0.0.0.0:8448
    ports: ["8005:8005", "8448:8448"]
    volumes:
      - ./certs/stg/cluster.crt:/etc/kong/tls/cluster.crt
      - ./certs/stg/cluster.key:/etc/kong/tls/cluster.key

  # ===========================================================================
  # PROD ENV (Ports 8006, 8007)
  # ===========================================================================
  gateway-prod-external:
    <<: *kong-env
    container_name: kong-prod-external
    environment:
      <<: *kong-env
      KONG_KONNECT_TAGS: "external"
      KONG_PROXY_LISTEN: 0.0.0.0:8006
      KONG_SSL_PXY_LISTEN: 0.0.0.0:8449
    ports: ["8006:8006", "8449:8449"]
    volumes:
      - ./certs/prod/cluster.crt:/etc/kong/tls/cluster.crt
      - ./certs/prod/cluster.key:/etc/kong/tls/cluster.key

  gateway-prod-internal:
    <<: *kong-env
    container_name: kong-prod-internal
    environment:
      <<: *kong-env
      KONG_KONNECT_TAGS: "internal"
      KONG_PROXY_LISTEN: 0.0.0.0:8007
      KONG_SSL_PXY_LISTEN: 0.0.0.0:8450
    ports: ["8007:8007", "8450:8450"]
    volumes:
      - ./certs/prod/cluster.crt:/etc/kong/tls/cluster.crt
      - ./certs/prod/cluster.key:/etc/kong/tls/cluster.key
