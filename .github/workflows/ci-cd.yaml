name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, uat, stg, prod]
      deploy:
        description: 'Deploy to Kong Konnect'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  lint:
    name: Lint OpenAPI Specification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: stoplightio/spectral-action@v0.8.10
        with:
          file_glob: spec/openapi.yaml
          spectral_ruleset: spectral.yaml

  build:
    name: Build Kong Configuration
    needs: lint
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}
      MANAGED_TAG: cicd
    outputs:
      artifact-name: kong-config
    steps:
      - uses: actions/checkout@v4

      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          deck-version: '1.55.0'  # Version actuelle stable

      - name: Setup yq
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Generate Kong base configuration
        run: |
          mkdir -p .generated
          deck file openapi2kong \
            --spec spec/openapi.yaml \
            --output-file .generated/kong.yaml
          
          echo "üîé DEBUG: Generated Config Content:"
          cat .generated/kong.yaml

      # ... reste inchang√© jusqu'√† l'upload artifact ...

      - name: Upload Kong configuration artifact
        uses: actions/upload-artifact@v4
        with:
          name: kong-config
          path: .generated/kong.yaml

  deploy:
    name: Deploy to Kong Konnect
    needs: build
    runs-on: self-hosted
    environment: 
      name: ${{ inputs.environment || 'dev' }}
      url: ${{ env.KONNECT_ADDR }}
    if: ${{ github.event_name == 'push' || inputs.deploy == true }}
    env:
      KONNECT_TOKEN: ${{ secrets.KONNECT_PAT }}
      KONNECT_ADDR: ${{ vars.CP_URL }}
      MANAGED_TAG: cicd
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}
      CP_DEV: ${{ vars.CP_DEV }}
      CP_UAT: ${{ vars.CP_UAT }}
      CP_STG: ${{ vars.CP_STG }}
      CP_PRD: ${{ vars.CP_PRD }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: kong-config
          path: .generated

      - name: Validate local decK installation
        run: |
          echo "/opt/homebrew/bin" >> $GITHUB_PATH
          export PATH="/opt/homebrew/bin:$PATH"
          if ! command -v deck &> /dev/null; then
            echo "::error::decK not found. Install manually."
            exit 1
          fi
          deck version

      - name: Load Environment Configuration
        id: config
        run: |
          CONFIG_FILE="config/vars/${ENVIRONMENT}-envs.json"
          if [ "$ENVIRONMENT" == "prod" ]; then
            echo "KONNECT_CP_NAME=$CP_PRD" >> $GITHUB_ENV
            SELECTED_CP="$CP_PRD"
          elif [ "$ENVIRONMENT" == "stg" ]; then
            echo "KONNECT_CP_NAME=$CP_STG" >> $GITHUB_ENV
            SELECTED_CP="$CP_STG"
          elif [ "$ENVIRONMENT" == "uat" ]; then
            echo "KONNECT_CP_NAME=$CP_UAT" >> $GITHUB_ENV
            SELECTED_CP="$CP_UAT"
          else
            echo "KONNECT_CP_NAME=$CP_DEV" >> $GITHUB_ENV
            SELECTED_CP="$CP_DEV"
          fi

          if [ -f "$CONFIG_FILE" ]; then
            HOST=$(jq -r '.route_external' "$CONFIG_FILE")
            PROTOCOL=$(jq -r '.protocol // "https"' "$CONFIG_FILE")
            if [[ "$HOST" == *"localhost"* ]]; then
              PROTOCOL="http"
            fi
            echo "PROXY_URL=${PROTOCOL}://${HOST}" >> $GITHUB_ENV
            echo "Targeting CP: $SELECTED_CP ($PROTOCOL://${HOST})"
          else
            echo "::error::Config file not found: $CONFIG_FILE"
            exit 1
          fi

      - name: Check connectivity
        run: |
          deck gateway ping \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME"

      - name: Backup current configuration
        run: |
          deck gateway dump \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME" \
            --select-tag "$MANAGED_TAG" \
            --output-file backup.yaml || echo "No existing config"

      - name: Deploy configuration (scoped & safe)
        id: deploy_step
        run: |
          deck gateway sync .generated/kong.yaml \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME" \
            --select-tag "$MANAGED_TAG"

      - name: Run Postman Tests
        id: postman_tests
        run: |
          echo "‚è≥ Waiting 15s for Kong to stabilize..."
          sleep 15
          COLLECTION_FILE="tests/${GITHUB_REPOSITORY##*/}-integration-tests-${ENVIRONMENT}.json"
          if [ ! -f "$COLLECTION_FILE" ]; then
            echo "Specific collection $COLLECTION_FILE not found, using default tests/integration-tests.json"
            COLLECTION_FILE="tests/integration-tests.json"
          fi
          
          # Use npx to run newman without global install/sudo
          npx newman run "$COLLECTION_FILE" \
            --env-var baseUrl="$PROXY_URL" \
            --reporters cli \
            --timeout-request 10000 \
            --timeout 60000

      - name: Rollback deployment
        if: failure() && steps.deploy_step.outcome == 'success'
        run: |
          echo "üö® Postman tests failed! Rolling back..."
          if [ -f "backup.yaml" ] && [ -s "backup.yaml" ]; then
            deck gateway sync backup.yaml \
              --konnect-token "$KONNECT_TOKEN" \
              --konnect-addr "$KONNECT_ADDR" \
              --konnect-control-plane-name "$KONNECT_CP_NAME" \
              --select-tag "$MANAGED_TAG"
            echo "‚úÖ Rollback completed."
          else
            echo "‚ö†Ô∏è No backup found, cannot rollback."
          fi
