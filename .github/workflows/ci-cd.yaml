name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        default: dev
        type: choice
        options: [dev, uat, stg, prod]
      deploy:
        description: Deploy to Kong Konnect
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
# --------------------------------------------------
# LINT
# --------------------------------------------------
  lint:
    name: Lint OpenAPI Specification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: stoplightio/spectral-action@v0.8.10
        with:
          file_glob: spec/openapi.yaml
          spectral_ruleset: spectral.yaml

# --------------------------------------------------
# BUILD
# --------------------------------------------------
  build:
    name: Build Kong Configuration
    needs: lint
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}
      MANAGED_TAG: cicd

    steps:
      - uses: actions/checkout@v4

      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          deck-version: '1.55.0'

      - name: Setup yq
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Generate Kong base configuration
        run: |
          mkdir -p .generated
          deck file openapi2kong \
            --spec spec/openapi.yaml \
            --output-file .generated/kong.yaml

      - name: Split Horizon (Internal / External routes)
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          CONFIG_FILE="config/vars/${ENVIRONMENT}-envs.json"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "::error::Missing env config $CONFIG_FILE"
            exit 1
          fi

          # Substitute environment variables in config
          envsubst < "$CONFIG_FILE" > .generated/envs.json
          
          echo "=== Environment config ==="
          cat .generated/envs.json
          
          echo "=== Initial routes from OpenAPI ==="
          yq eval '.services[0].routes[].name' .generated/kong.yaml || echo "No routes found"

          # Split each route into external and internal variants
          # Create external routes
          yq eval-all '
            (select(fileIndex == 1).route_external) as $extHost |
            (select(fileIndex == 1)) as $env |
            select(fileIndex == 0) |
            .services[0] *= $env |
            .services[0].routes = [
              .services[0].routes[] | 
              . as $r |
              ($r | del(.id) | .name = $r.name + "-external" | .tags = ["external","cicd"] | .hosts = [$extHost])
            ] |
            del(.services[0].route_external) |
            del(.services[0].route_internal) |
            del(.services[0].enabled)
          ' .generated/kong.yaml .generated/envs.json > .generated/kong-ext.yaml

          # Create internal routes
          yq eval-all '
            (select(fileIndex == 1).route_internal) as $intHost |
            (select(fileIndex == 1)) as $env |
            select(fileIndex == 0) |
            .services[0] *= $env |
            .services[0].routes = [
              .services[0].routes[] | 
              . as $r |
              ($r | del(.id) | .name = $r.name + "-internal" | .tags = ["internal","cicd"] | .hosts = [$intHost])
            ] |
            del(.services[0].route_external) |
            del(.services[0].route_internal) |
            del(.services[0].enabled)
          ' .generated/kong.yaml .generated/envs.json > .generated/kong-int.yaml

          # Merge external and internal routes
          yq eval-all '
            (select(fileIndex == 0).services[0].routes) as $extRoutes |
            (select(fileIndex == 1).services[0].routes) as $intRoutes |
            select(fileIndex == 0) |
            .services[0].routes = ($extRoutes + $intRoutes) |
            .services[0] *= (select(fileIndex == 1).services[0] | del(.routes))
          ' .generated/kong-ext.yaml .generated/kong-int.yaml > .generated/kong.tmp.yaml

          # Add hosts to routes (post-processing)
          yq eval-all '
            (select(fileIndex == 1).route_external) as $extHost |
            (select(fileIndex == 1).route_internal) as $intHost |
            select(fileIndex == 0) |
            .services[0].routes[] |= (
              (select(.tags | contains(["external"])) | .hosts = [$extHost]) // . |
              (select(.tags | contains(["internal"])) | .hosts = [$intHost]) // .
            )
          ' .generated/kong.tmp.yaml .generated/envs.json > .generated/kong.yaml
          
          echo "=== Routes after split horizon ==="
          yq eval '.services[0].routes[] | .name + " - tags: " + (.tags | join(",")) + " - hosts: " + (.hosts | join(","))' .generated/kong.yaml

      - name: Apply security plugins (Public routes)
        run: |
          # Apply public template to external routes
          yq eval-all '
            (select(fileIndex == 1).plugins) as $p |
            select(fileIndex == 0) |
            .services[0].routes[] |= (
              (select(.tags | contains(["external"])) | .plugins += $p) // .
            )
          ' .generated/kong.yaml config/templates/public.yaml > .generated/kong.tmp.yaml
          
          # Merge CA certificates separately if they exist
          if yq eval '.ca_certificates' config/templates/public.yaml > /dev/null 2>&1; then
            yq eval-all '
              (select(fileIndex == 1).ca_certificates) as $certs |
              select(fileIndex == 0) |
              .ca_certificates = $certs
            ' .generated/kong.tmp.yaml config/templates/public.yaml > .generated/kong.ext.yaml
          else
            mv .generated/kong.tmp.yaml .generated/kong.ext.yaml
          fi

      - name: Apply security plugins (Private routes)
        run: |
          # Apply private template to internal routes
          yq eval-all '
            (select(fileIndex == 1).plugins) as $p |
            select(fileIndex == 0) |
            .services[0].routes[] |= (
              (select(.tags | contains(["internal"])) | .plugins += $p) // .
            )
          ' .generated/kong.ext.yaml config/templates/private.yaml > .generated/kong.final.yaml

          mv .generated/kong.final.yaml .generated/kong.yaml

      - name: Verify routes generation
        run: |
          echo "=== Verifying generated routes ==="
          EXTERNAL_COUNT=$(yq eval '.services[0].routes[] | select(.tags | contains(["external"])) | .name' .generated/kong.yaml | wc -l)
          INTERNAL_COUNT=$(yq eval '.services[0].routes[] | select(.tags | contains(["internal"])) | .name' .generated/kong.yaml | wc -l)
          echo "External routes: $EXTERNAL_COUNT"
          echo "Internal routes: $INTERNAL_COUNT"
          echo "Total routes: $((EXTERNAL_COUNT + INTERNAL_COUNT))"
          
          if [ "$EXTERNAL_COUNT" -eq 0 ] || [ "$INTERNAL_COUNT" -eq 0 ]; then
            echo "::error::Missing routes! Expected both external and internal routes."
            exit 1
          fi
          
          echo "=== Route names ==="
          yq eval '.services[0].routes[].name' .generated/kong.yaml

      - name: Tag managed resources
        run: |
          yq eval '.services[].tags += ["cicd"] | .services[].tags |= unique' -i .generated/kong.yaml

      - name: Debug - Print Generated Config
        run: cat .generated/kong.yaml

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kong-config
          path: .generated/kong.yaml

# --------------------------------------------------
# DEPLOY
# --------------------------------------------------
  deploy:
    name: Deploy to Kong Konnect
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || inputs.deploy == true }}

    env:
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}
      KONNECT_TOKEN: ${{ secrets.KONNECT_PAT }}
      KONNECT_ADDR: ${{ vars.CP_URL }}
      MANAGED_TAG: cicd
      CP_DEV: ${{ vars.CP_DEV }}
      CP_UAT: ${{ vars.CP_UAT }}
      CP_STG: ${{ vars.CP_STG }}
      CP_PRD: ${{ vars.CP_PRD }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: kong-config
          path: .generated

      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          deck-version: '1.55.0'

      - name: Resolve Control Plane & URL
        run: |
          case "$ENVIRONMENT" in
            prod) CP="$CP_PRD" ;;
            stg)  CP="$CP_STG" ;;
            uat)  CP="$CP_UAT" ;;
            *)    CP="$CP_DEV" ;;
          esac

          HOST=$(jq -r '.route_external' config/vars/${ENVIRONMENT}-envs.json)
          PROTOCOL="https"
          [[ "$HOST" == *localhost* ]] && PROTOCOL="http"

          echo "KONNECT_CP_NAME=$CP" >> $GITHUB_ENV
          echo "PROXY_URL=$PROTOCOL://$HOST" >> $GITHUB_ENV

      - name: Deploy
        id: deploy
        run: |
          deck gateway sync .generated/kong.yaml \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME" \
            --select-tag "$MANAGED_TAG"
            
      - name: ⚠️ Notice
        run: echo "Deployment only mode. No connectivity checks or tests ran (Cloud Runner)."
