name: CI/CD Pipeline

# -------------------------------------------------------------------------------------------------
# Best Practices implemented:
# 1. Least Privilege: minimal GITHUB_TOKEN permissions.
# 2. Linting: OpenAPI validation with Spectral.
# 3. Single Source of Truth: OpenAPI -> Kong configuration.
# 4. Dynamic Patching: environment + security profiles.
# 5. Safety: non-strict sync to avoid destructive deletes.
# 6. Idempotency: add/update only behavior.
# -------------------------------------------------------------------------------------------------

on:
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        default: dev
        type: choice
        options: [dev, uat, stg, prod]

      security_profile:
        description: 'Security profile'
        required: false
        default: internal
        type: choice
        options: [internal, mtls]

      deploy:
        description: 'Deploy to Kong Konnect'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  # ===============================================================================================
  # JOB 1: LINT
  # ===============================================================================================
  lint:
    name: Lint OpenAPI Specification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Lint OpenAPI with Spectral
        uses: stoplightio/spectral-action@v0.8.10
        with:
          file_glob: spec/openapi.yaml
          spectral_ruleset: spectral.yaml

  # ===============================================================================================
  # JOB 2: BUILD
  # ===============================================================================================
  build:
    name: Build Kong Configuration
    needs: lint
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}
      SECURITY_PROFILE: ${{ inputs.security_profile || 'internal' }}

    outputs:
      artifact-name: kong-config

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          deck-version: '1.40.3'

      - name: Setup yq
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Generate Kong base configuration from OpenAPI
        run: |
          mkdir -p .generated
          deck file openapi2kong \
            --spec spec/openapi.yaml \
            --output-file .generated/kong.yaml

      - name: Inject environment configuration
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          CONFIG_FILE="config/vars/${ENVIRONMENT}-envs.json"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "::error::Missing environment config: $CONFIG_FILE"
            exit 1
          fi

          envsubst < "$CONFIG_FILE" > .generated/envs_resolved.json

          yq eval-all '
            select(fileIndex == 0).services[0] *= select(fileIndex == 1)
            | select(fileIndex == 0)
          ' .generated/kong.yaml .generated/envs_resolved.json > .generated/kong_patched.yaml

          mv .generated/kong_patched.yaml .generated/kong.yaml

      - name: Apply security profile templates
        run: |
          TEMPLATE="config/templates/${SECURITY_PROFILE}.yaml"

          if [ ! -f "$TEMPLATE" ]; then
            echo "::error::Missing security template: $TEMPLATE"
            exit 1
          fi

          deck file merge \
            .generated/kong.yaml \
            "$TEMPLATE" \
            --output-file .generated/kong.yaml

      - name: Validate generated Kong configuration
        run: |
          deck file validate .generated/kong.yaml

      - name: Upload Kong configuration artifact
        uses: actions/upload-artifact@v4
        with:
          name: kong-config
          path: .generated/kong.yaml

  # ===============================================================================================
  # JOB 3: DEPLOY
  # ===============================================================================================
  deploy:
    name: Deploy to Kong Konnect
    needs: build
    runs-on: ubuntu-latest

    if: ${{ github.event_name == 'push' || inputs.deploy == true }}

    env:
      KONNECT_TOKEN: ${{ secrets.KONNECT_PAT }}
      KONNECT_ADDR: ${{ vars.CP_URL }}
      KONNECT_CP_NAME: ${{ vars.CP_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Kong configuration artifact
        uses: actions/download-artifact@v4
        with:
          name: kong-config
          path: .generated

      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          deck-version: '1.40.3'

      - name: Check connectivity to Konnect Control Plane
        run: |
          deck gateway ping \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME"

      - name: Deploy configuration (safe mode)
        run: |
          deck gateway sync .generated/kong.yaml \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME" \
            --non-strict
