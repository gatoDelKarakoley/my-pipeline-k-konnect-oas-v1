name: CI/CD Pipeline

# -------------------------------------------------------------------------------------------------
# Best Practices implemented:
# 1. Least Privilege: minimal GITHUB_TOKEN permissions.
# 2. Linting: OpenAPI validation with Spectral.
# 3. Single Source of Truth: OpenAPI -> Kong configuration.
# 4. Dynamic Patching: environment + security profiles.
# 5. Scoped Sync: decK manages ONLY tagged objects (no destructive deletes).
# 6. Idempotency: create + update only for managed resources.
# -------------------------------------------------------------------------------------------------

on:
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        default: dev
        type: choice
        options: [dev, uat, stg, prod]

      is_public:
        description: 'Public API? (activates mTLS + OIDC)'
        required: true
        type: boolean
        default: false

      deploy:
        description: 'Deploy to Kong Konnect'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  # ===============================================================================================
  # JOB 1: LINT
  # ===============================================================================================
  lint:
    name: Lint OpenAPI Specification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Lint OpenAPI with Spectral
        uses: stoplightio/spectral-action@v0.8.10
        with:
          file_glob: spec/openapi.yaml
          spectral_ruleset: spectral.yaml

  # ===============================================================================================
  # JOB 2: BUILD
  # ===============================================================================================
  build:
    name: Build Kong Configuration
    needs: lint
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}
      # Logic: If is_public is true -> mtls-oidc, else -> internal
      SECURITY_PROFILE: ${{ inputs.is_public == true && 'mtls-oidc' || 'internal' }}
      MANAGED_TAG: cicd

    outputs:
      artifact-name: kong-config


    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          deck-version: '1.40.3'

      - name: Setup yq
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Generate Kong base configuration from OpenAPI
        run: |
          mkdir -p .generated
          deck file openapi2kong \
            --spec spec/openapi.yaml \
            --output-file .generated/kong.yaml

      - name: Inject environment configuration
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          CONFIG_FILE="config/vars/${ENVIRONMENT}-envs.json"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "::error::Missing environment config: $CONFIG_FILE"
            exit 1
          fi

          envsubst < "$CONFIG_FILE" > .generated/envs_resolved.json

          yq eval-all '
            select(fileIndex == 0).services[0] *= select(fileIndex == 1)
            | select(fileIndex == 0)
          ' .generated/kong.yaml .generated/envs_resolved.json > .generated/kong_patched.yaml

          mv .generated/kong_patched.yaml .generated/kong.yaml

      - name: Apply security profile templates
        run: |
          TEMPLATE="config/templates/${SECURITY_PROFILE}.yaml"

          if [ ! -f "$TEMPLATE" ]; then
            echo "::error::Missing security template: $TEMPLATE"
            exit 1
          fi

          # Use yq to inject plugins into the Service (Service-Scoped) instead of Global
          yq eval-all '
            select(fileIndex == 0).services[0].plugins += select(fileIndex == 1).plugins
            | select(fileIndex == 0)
          ' .generated/kong.yaml "$TEMPLATE" > .generated/kong_secured.yaml

          mv .generated/kong_secured.yaml .generated/kong.yaml

      # üîê TAG EVERYTHING MANAGED BY THIS PIPELINE
      - name: Tag managed resources
        run: |
          yq eval '
            .services[].tags += ["'${MANAGED_TAG}'"]
          ' -i .generated/kong.yaml

      - name: Validate generated Kong configuration
        run: |
          deck file validate .generated/kong.yaml

      - name: Upload Kong configuration artifact
        uses: actions/upload-artifact@v4
        with:
          name: kong-config
          path: .generated/kong.yaml

  # ===============================================================================================
  # JOB 3: DEPLOY
  # ===============================================================================================
  deploy:
    name: Deploy to Kong Konnect
    needs: build
    runs-on: ubuntu-latest

    # Blocking Gate: This maps to GitHub Environments.
    # Go to Repo Settings -> Environments -> [dev/uat/stg/prod] -> Required Reviewers to enforce "Click to Approve".
    environment: 
      name: ${{ inputs.environment || 'dev' }}
      url: ${{ env.KONNECT_ADDR }}

    if: ${{ github.event_name == 'push' || inputs.deploy == true }}

    env:
      KONNECT_TOKEN: ${{ secrets.KONNECT_PAT }}
      KONNECT_ADDR: ${{ vars.CP_URL }}
      MANAGED_TAG: cicd
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}
      # Map GitHub Variables for CP Names
      CP_DEV: ${{ vars.CP_DEV }}
      CP_UAT: ${{ vars.CP_UAT }}
      CP_STG: ${{ vars.CP_STG }}
      CP_PRD: ${{ vars.CP_PRD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Kong configuration artifact
        uses: actions/download-artifact@v4
        with:
          name: kong-config
          path: .generated

      - name: Setup decK
        uses: kong/setup-deck@v1
        with:
          deck-version: '1.40.3'

      - name: Load Environment Configuration
        id: config
        run: |
          CONFIG_FILE="config/vars/${ENVIRONMENT}-envs.json"
          
          # Determine Control Plane Name from GitHub Variables
          if [ "$ENVIRONMENT" == "prod" ]; then
             echo "KONNECT_CP_NAME=$CP_PRD" >> $GITHUB_ENV
             SELECTED_CP="$CP_PRD"
          elif [ "$ENVIRONMENT" == "stg" ]; then
             echo "KONNECT_CP_NAME=$CP_STG" >> $GITHUB_ENV
             SELECTED_CP="$CP_STG"
          elif [ "$ENVIRONMENT" == "uat" ]; then
             echo "KONNECT_CP_NAME=$CP_UAT" >> $GITHUB_ENV
             SELECTED_CP="$CP_UAT"
          else
             echo "KONNECT_CP_NAME=$CP_DEV" >> $GITHUB_ENV
             SELECTED_CP="$CP_DEV"
          fi
          
          if [ -f "$CONFIG_FILE" ]; then
             # Extract Host for Proxy URL (used in tests later)
             HOST=$(jq -r '.host' "$CONFIG_FILE")
             PROTOCOL=$(jq -r '.protocol // "https"' "$CONFIG_FILE")
             echo "PROXY_URL=${PROTOCOL}://${HOST}" >> $GITHUB_ENV
             
             echo "Targeting CP: $SELECTED_CP ($PROTOCOL://${HOST})"
          else
             echo "::error::Config file not found: $CONFIG_FILE"
             exit 1
          fi

      - name: Check connectivity to Konnect Control Plane
        run: |
          deck gateway ping \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME"

      # BACKUP: Dump current state before making changes
      - name: Backup current configuration
        run: |
          deck gateway dump \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME" \
            --select-tag "$MANAGED_TAG" \
            --output-file backup.yaml || echo "No existing config or backup failed"

      # DEPLOY: Apply new configuration
      - name: Deploy configuration (scoped & safe)
        id: deploy_step
        run: |
          deck gateway sync .generated/kong.yaml \
            --konnect-token "$KONNECT_TOKEN" \
            --konnect-addr "$KONNECT_ADDR" \
            --konnect-control-plane-name "$KONNECT_CP_NAME" \
            --select-tag "$MANAGED_TAG"

      # TEST: Run Postman Integration Tests
      - name: Run Postman Tests
        id: postman_tests
        run: |
          # Install newman (Postman CLI)
          sudo npm install -g newman
          
          # Construct the expected collection filename pattern per user request:
          # ${REPO_NAME}-integration-tests-${ENVIRONMENT}.json
          COLLECTION_FILE="tests/${GITHUB_REPOSITORY##*/}-integration-tests-${ENVIRONMENT}.json"
          
          if [ ! -f "$COLLECTION_FILE" ]; then
            echo "Specific collection $COLLECTION_FILE not found, using default tests/integration-tests.json"
            COLLECTION_FILE="tests/integration-tests.json"
          fi

          echo "Running collection: $COLLECTION_FILE against $PROXY_URL"

          newman run "$COLLECTION_FILE" --env-var baseUrl="$PROXY_URL" --reporters cli

      # ROLLBACK: Revert if tests fail (but deploy succeeded)
      - name: Rollback deployment
        if: failure() && steps.deploy_step.outcome == 'success'
        run: |
          echo "üö® Postman tests failed! Rolling back to previous state..."
          if [ -f "backup.yaml" ] && [ -s "backup.yaml" ]; then
             deck gateway sync backup.yaml \
              --konnect-token "$KONNECT_TOKEN" \
              --konnect-addr "$KONNECT_ADDR" \
              --konnect-control-plane-name "$KONNECT_CP_NAME" \
              --select-tag "$MANAGED_TAG"
             echo "‚úÖ Rollback completed."
          else
             echo "‚ö†Ô∏è No backup found (first deploy?), cannot rollback."
          fi
