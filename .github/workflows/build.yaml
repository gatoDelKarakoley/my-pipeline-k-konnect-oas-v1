name: Build and Package API

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, uat, stg, prod]
      security_profile:
        description: 'Security Profile'
        required: true
        default: 'internal'
        type: choice
        options: [internal, mtls]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ inputs.environment || 'dev' }} 
      # Fallback to dev on push
    steps:
    - uses: actions/checkout@v4

    - name: Setup tools
      uses: kong/setup-deck@v1
      with:
        deck-version: '1.40.3'

    - name: Setup yq
      run: |
        wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        chmod +x /usr/bin/yq

    - name: Generate Base Config
      run: |
        mkdir -p .generated
        deck file openapi2kong --spec api/openapi.yaml --output-file .generated/kong.yaml

    - name: Inject Environment Variables and Rename Service
      env:
        REPO_NAME: ${{ github.event.repository.name }}
      run: |
        echo "Building for environment: $ENVIRONMENT"
        CONFIG_FILE="config/${ENVIRONMENT}-envs.json"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "Error: Config file $CONFIG_FILE not found!"
          exit 1
        fi

        # 1. Substitute vars in the env config
        envsubst < "$CONFIG_FILE" > .generated/envs_resolved.json
        
        # 2. Patch the Kong Config (YAML) using data from JSON
        yq eval-all 'select(fileIndex == 0).services[0] *= select(fileIndex == 1) | select(fileIndex == 0)' \
          .generated/kong.yaml .generated/envs_resolved.json > .generated/kong_patched.yaml

        mv .generated/kong_patched.yaml .generated/kong.yaml

    - name: Apply Security Profile
      run: |
        deck file merge .generated/kong.yaml config/templates/${{ inputs.security_profile || 'internal' }}.yaml --output-file .generated/kong.yaml

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: kong-config-${{ env.ENVIRONMENT }}
        path: .generated/kong.yaml
